# 1. Configuration from your XML
$deploymentUrl = "https://cmedirect.cmegroup.com/client/CMEDirect.application"
$regPath = "HKLM:\SOFTWARE\MICROSOFT\.NETFramework\Security\TrustManager\PromptingLevel"
$zonePath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ZoneMap\Domains\cmegroup.com"

# 2. Capture Current Values (so we can put them back)
Write-Host "Backing up current registry states..." -ForegroundColor Cyan
$originalInternetVal = (Get-ItemProperty -Path $regPath -Name "Internet" -ErrorAction SilentlyContinue).Internet
$originalIntranetVal = (Get-ItemProperty -Path $regPath -Name "LocalIntranet" -ErrorAction SilentlyContinue).LocalIntranet

# 3. Apply Temporary "Silent" Settings
Write-Host "Applying temporary trust settings for CME Direct..." -ForegroundColor Yellow
if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
Set-ItemProperty -Path $regPath -Name "Internet" -Value "Enabled"
Set-ItemProperty -Path $regPath -Name "LocalIntranet" -Value "Enabled"

# Add CME to Trusted Sites temporarily to bypass Server 2016 security blocks
if (!(Test-Path $zonePath)) { New-Item -Path $zonePath -Force }
Set-ItemProperty -Path $zonePath -Name "https" -Value 2

# 4. Trigger the Installation
Write-Host "Launching CME Direct Silent Installer..." -ForegroundColor Green
$process = Start-Process "rundll32.exe" -ArgumentList "dfshim.dll,ShOpenVerbApplication $deploymentUrl" -Wait -PassThru

# Note: dfshim.dll sometimes returns immediately while the installer runs in background. 
# We'll pause for 60 seconds to ensure the 'Install' handshake finishes.
Start-Sleep -Seconds 60

# 5. Restore Original Settings
Write-Host "Restoring original security settings..." -ForegroundColor Cyan

# Restore TrustManager
if ($null -eq $originalInternetVal) { 
    Remove-ItemProperty -Path $regPath -Name "Internet" -ErrorAction SilentlyContinue 
} else { 
    Set-ItemProperty -Path $regPath -Name "Internet" -Value $originalInternetVal 
}

if ($null -eq $originalIntranetVal) { 
    Remove-ItemProperty -Path $regPath -Name "LocalIntranet" -ErrorAction SilentlyContinue 
} else { 
    Set-ItemProperty -Path $regPath -Name "LocalIntranet" -Value $originalIntranetVal 
}

# Remove the temporary Trusted Site entry
Remove-Item -Path $zonePath -Recurse -ErrorAction SilentlyContinue

Write-Host "CME Direct Installation Attempt Complete and System Restored." -ForegroundColor White
